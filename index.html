<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; padding: 20px; text-align: center; }
        .btn { background-color: #06C755; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 20px; width: 100%; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; } /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏±‡∏á‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ */
        h2 { color: #333; }
        #status { font-size: 12px; color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2>üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á</h2>
    <p>‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏¢!</p>
    
    <p id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</p>

    <input type="text" id="calendar" placeholder="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô..." style="display:none;">
    
    <button class="btn" id="submitBtn" disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</button>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ---
        const MY_LIFF_ID = "2008649534-6mDQ8Amx"; 
        const N8N_WEBHOOK_URL = "https://may12345.app.n8n.cloud/webhook/trip-planner"; 

        let selectedDates = [];
        let userProfile = null; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô null
        let context = null;

        // --- 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô ---
        flatpickr("#calendar", {
            mode: "multiple",
            dateFormat: "Y-m-d",
            inline: true,
            onChange: function(selectedDatesStr, dateStr) {
                selectedDates = dateStr.split(', ');
            }
        });

        // --- 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
                userProfile = await liff.getProfile();
                context = liff.getContext();

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°
                document.getElementById('status').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${userProfile.displayName}`;
                const btn = document.getElementById('submitBtn');
                btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á";
                btn.disabled = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°

            } catch (err) {
                document.getElementById('status').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE";
                alert("LIFF Error: " + err);
            }
        }
        main();

        // --- 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        document.getElementById('submitBtn').addEventListener('click', () => {
            if (selectedDates.length === 0 || selectedDates[0] === "") {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Ç‡∏≠‡∏á Group ID (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°)
            // ‡∏ñ‡πâ‡∏≤ context ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ groupId ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÜ ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á "Individual"
            const groupId = (context && context.groupId) ? context.groupId : "Individual";

            const dataToSend = {
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                groupId: groupId,
                dates: selectedDates
            };

            // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Code ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô)
            // alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + JSON.stringify(dataToSend)); 

            fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                if(response.ok) {
                    liff.closeWindow();
                } else {
                    alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à Status: " + response.status);
                }
            })
            .catch(error => {
                alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà Internet ‡∏´‡∏£‡∏∑‡∏≠ n8n: " + error);
            });
        });
    </script>
</body>
</html>